#!/usr/bin/env bash

url="${1}"

downloadTimestamp="$(date +'%F %T %Z')";
downloadTimestamp="${downloadTimestamp//:/\\:}";

yt-dlp -f "bestvideo+bestaudio/best" \
  -o "%(uploader)s - 1x%(playlist_index)03d - %(title)s.%(ext)s" \
  --parse-metadata "${downloadTimestamp}:%(meta_download_date)s" \
  --parse-metadata "%(like_count)s:%(meta_likes)s" \
  --parse-metadata "%(dislike_count)s:%(meta_dislikes)s" \
  --parse-metadata "%(view_count)s:%(meta_views)s" \
  --parse-metadata "%(average_rating)s:%(meta_rating)s" \
  --parse-metadata "%(release_date>%Y-%m-%d,upload_date>%Y-%m-%d)s:%(meta_publish_date)s" \
  --quiet --no-warnings \
  --write-info-json \
  --write-thumbnail \
  --ignore-errors --prefer-free-formats \
  --xattrs --no-overwrites \
  --sub-lang en --embed-subs --add-metadata --merge-output-format mkv \
  --write-auto-subs --embed-metadata --embed-thumbnail \
  --compat-options playlist-index --playlist-reverse \
  --no-windows-filenames \
  --cookies-from-browser firefox \
  "${url}"

for f in *.info.json; do
    ~/.pyenv/versions/ytdl-nfo/bin/ytdl-nfo "${f}"
    rm "${f}"
done

mogrify -format jpg *.webp *.png
rm *.webp
rm *.png
rm *' 000 '*

for f in *.jpg; do
    mv "${f}" "$(echo "${f}" | sed s/.jpg/-thumb.jpg/)"
done
